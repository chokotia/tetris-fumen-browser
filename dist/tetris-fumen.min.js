!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.TetrisFumen=t():e.TetrisFumen=t()}(self,()=>(()=>{"use strict";var e={42:function(e,t,r){var i=this&&this.__assign||function(){return i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.createActionEncoder=t.createActionDecoder=void 0;var n=r(746);function o(e){return 0!==e}function c(e){return e?1:0}t.createActionDecoder=function(e,t,r){var c=(t+r)*e;return{decode:function(r){var a=r,s=function(e){switch(e){case 0:return n.Piece.Empty;case 1:return n.Piece.I;case 2:return n.Piece.L;case 3:return n.Piece.O;case 4:return n.Piece.Z;case 5:return n.Piece.T;case 6:return n.Piece.J;case 7:return n.Piece.S;case 8:return n.Piece.Gray}throw new Error("Unexpected piece")}(a%8),u=function(e){switch(e){case 0:return n.Rotation.Reverse;case 1:return n.Rotation.Right;case 2:return n.Rotation.Spawn;case 3:return n.Rotation.Left}throw new Error("Unexpected rotation")}((a=Math.floor(a/8))%4),f=function(r,i,o){var c=r%e,a=Math.floor(r/10),s=t-a-1;return i===n.Piece.O&&o===n.Rotation.Left?(c+=1,s-=1):i===n.Piece.O&&o===n.Rotation.Reverse?c+=1:i===n.Piece.O&&o===n.Rotation.Spawn?s-=1:i===n.Piece.I&&o===n.Rotation.Reverse?c+=1:i===n.Piece.I&&o===n.Rotation.Left||i===n.Piece.S&&o===n.Rotation.Spawn?s-=1:i===n.Piece.S&&o===n.Rotation.Right?c-=1:i===n.Piece.Z&&o===n.Rotation.Spawn?s-=1:i===n.Piece.Z&&o===n.Rotation.Left&&(c+=1),{x:c,y:s}}((a=Math.floor(a/4))%c,s,u);return{rise:o((a=Math.floor(a/c))%2),mirror:o((a=Math.floor(a/2))%2),colorize:o((a=Math.floor(a/2))%2),comment:o((a=Math.floor(a/2))%2),lock:!o((a=Math.floor(a/2))%2),piece:i(i({},f),{type:s,rotation:u})}}}},t.createActionEncoder=function(e,t,r){var i=(t+r)*e;return{encode:function(r){var o,a,s,u,f,p=r.lock,l=r.comment,h=r.colorize,d=r.mirror,v=r.rise,y=r.piece,g=c(!p);return g*=2,g+=c(l),g*=2,g+=c(h),g*=2,g+=c(d),g*=2,g+=c(v),g*=i,g+=(a=(o=y).type,s=o.rotation,u=o.x,f=o.y,(0,n.isMinoPiece)(a)?a===n.Piece.O&&s===n.Rotation.Left?(u-=1,f+=1):a===n.Piece.O&&s===n.Rotation.Reverse?u-=1:a===n.Piece.O&&s===n.Rotation.Spawn?f+=1:a===n.Piece.I&&s===n.Rotation.Reverse?u-=1:a===n.Piece.I&&s===n.Rotation.Left||a===n.Piece.S&&s===n.Rotation.Spawn?f+=1:a===n.Piece.S&&s===n.Rotation.Right?u+=1:a===n.Piece.Z&&s===n.Rotation.Spawn?f+=1:a===n.Piece.Z&&s===n.Rotation.Left&&(u-=1):(u=0,f=22),(t-f-1)*e+u),g*=4,g+=function(e){var t=e.type,r=e.rotation;if(!(0,n.isMinoPiece)(t))return 0;switch(r){case n.Rotation.Reverse:return 0;case n.Rotation.Right:return 1;case n.Rotation.Spawn:return 2;case n.Rotation.Left:return 3}throw new Error("No reachable")}(y),(g*=8)+y.type}}}},74:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Buffer=void 0;var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=function(){function e(e){void 0===e&&(e=""),this.values=e.split("").map(n)}return e.prototype.poll=function(t){for(var r=0,i=0;i<t;i+=1){var n=this.values.shift();if(void 0===n)throw new Error("Unexpected fumen");r+=n*Math.pow(e.tableLength,i)}return r},e.prototype.push=function(t,r){void 0===r&&(r=1);for(var i=t,n=0;n<r;n+=1)this.values.push(i%e.tableLength),i=Math.floor(i/e.tableLength)},e.prototype.merge=function(e){for(var t=0,r=e.values;t<r.length;t++){var i=r[t];this.values.push(i)}},e.prototype.isEmpty=function(){return 0===this.values.length},Object.defineProperty(e.prototype,"length",{get:function(){return this.values.length},enumerable:!1,configurable:!0}),e.prototype.get=function(e){return this.values[e]},e.prototype.set=function(e,t){this.values[e]=t},e.prototype.toString=function(){return this.values.map(o).join("")},e.tableLength=64,e}();function n(e){return r.indexOf(e)}function o(e){return r[e]}t.Buffer=i},254:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createCommentParser=void 0;var r=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";t.createCommentParser=function(){return{decode:function(e){for(var t="",i=e,n=0;n<4;n+=1)t+=r[i%96],i=Math.floor(i/96);return t},encode:function(e,t){return r.indexOf(e)*Math.pow(96,t)}}}},326:function(e,t,r){var i=this&&this.__assign||function(){return i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.Mino=t.Field=void 0;var n=r(917),o=r(746);function c(e){return e instanceof s?e.copy():s.from(e)}var a=function(){function e(e){this.field=e}return e.create=function(t,r){return new e(new n.InnerField({field:void 0!==t?n.PlayField.load(t):void 0,garbage:void 0!==r?n.PlayField.loadMinify(r):void 0}))},e.prototype.canFill=function(e){if(void 0===e)return!0;var t=c(e);return this.field.canFillAll(t.positions())},e.prototype.canLock=function(e){return void 0===e||!!this.canFill(e)&&!this.canFill(i(i({},e),{y:e.y-1}))},e.prototype.fill=function(e,t){if(void 0===t&&(t=!1),void 0!==e){var r=c(e);if(!t&&!this.canFill(r))throw Error("Cannot fill piece on field");return this.field.fillAll(r.positions(),(0,o.parsePiece)(r.type)),r}},e.prototype.put=function(e){if(void 0!==e){for(var t=c(e);0<=t.y;t.y-=1)if(this.canLock(t))return this.fill(t),t;throw Error("Cannot put piece on field")}},e.prototype.clearLine=function(){this.field.clearLine()},e.prototype.at=function(e,t){return(0,o.parsePieceName)(this.field.getNumberAt(e,t))},e.prototype.set=function(e,t,r){this.field.setNumberAt(e,t,(0,o.parsePiece)(r))},e.prototype.copy=function(){return new e(this.field.copy())},e.prototype.str=function(e){void 0===e&&(e={});for(var t=void 0===e.reduced||e.reduced,r=void 0!==e.separator?e.separator:"\n",i=void 0===e.garbage||e.garbage?-1:0,n="",o=22;i<=o;o-=1){for(var c="",a=0;a<10;a+=1)c+=this.at(a,o);t&&"__________"===c||(t=!1,n+=c,o!==i&&(n+=r))}return n},e}();t.Field=a;var s=function(){function e(e,t,r,i){this.type=e,this.rotation=t,this.x=r,this.y=i}return e.from=function(t){return new e(t.type,t.rotation,t.x,t.y)},e.prototype.positions=function(){return(0,n.getBlockXYs)((0,o.parsePiece)(this.type),(0,o.parseRotation)(this.rotation),this.x,this.y).sort(function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y})},e.prototype.operation=function(){return{type:this.type,rotation:this.rotation,x:this.x,y:this.y}},e.prototype.isValid=function(){try{(0,o.parsePiece)(this.type),(0,o.parseRotation)(this.rotation)}catch(e){return!1}return this.positions().every(function(e){var t=e.x,r=e.y;return 0<=t&&t<10&&0<=r&&r<23})},e.prototype.copy=function(){return new e(this.type,this.rotation,this.x,this.y)},e}();t.Mino=s},370:function(e,t,r){var i=this&&this.__assign||function(){return i=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},i.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.encode=void 0;var n=r(917),o=r(74),c=r(746),a=r(42),s=r(254),u=r(633);t.encode=function(e){for(var t=-1,r=new o.Buffer,f=(0,n.createNewInnerField)(),p=(0,a.createActionEncoder)(10,23,1),l=(0,s.createCommentParser)(),h="",d=void 0,v=function(a){var s=e[a];s.flags=s.flags?s.flags:{};var v=s.field,y=void 0!==v?(0,n.createInnerField)(v):f.copy();!function(e,i){var n=function(e,t){for(var r=new o.Buffer,i=function(r,i){var n=23-i-1;return t.getNumberAt(r,n)-e.getNumberAt(r,n)+8},n=function(e,t){var i=240*e+t;r.push(i,2)},c=!0,a=i(0,0),s=-1,u=0;u<24;u+=1)for(var f=0;f<10;f+=1){var p=i(f,u);p!==a?(n(a,s),s=0,a=p):s+=1}return n(a,s),8===a&&239===s&&(c=!1),{changed:c,values:r}}(e,i),c=n.changed,a=n.values;if(c)r.merge(a),t=-1;else if(t<0||r.get(t)===o.Buffer.tableLength-1)r.merge(a),r.push(0),t=r.length-1;else if(r.get(t)<o.Buffer.tableLength-1){var s=r.get(t);r.set(t,s+1)}}(f,y);var g,m=void 0===s.comment||0===a&&""===s.comment?void 0:s.comment,b=void 0!==s.operation?{type:(0,c.parsePiece)(s.operation.type),rotation:(0,c.parseRotation)(s.operation.rotation),x:s.operation.x,y:s.operation.y}:{type:c.Piece.Empty,rotation:c.Rotation.Reverse,x:0,y:22};if(void 0!==m?m.startsWith("#Q=")?void 0!==d&&d.format().toString()===m?g=void 0:(h=g=m,d=new u.Quiz(m)):void 0!==d&&d.format().toString()===m?(g=void 0,h=m,d=void 0):(g=h!==m?m:void 0,h=h!==m?g:h,d=void 0):(g=void 0,d=void 0),void 0!==d&&d.canOperate()&&s.flags.lock)if((0,c.isMinoPiece)(b.type))try{var P=d.nextIfEnd(),w=P.getOperation(b.type);d=P.operate(w)}catch(e){d=d.format()}else d=d.format();var x=i({lock:!0,colorize:0===a},s.flags),O={piece:b,rise:!!x.rise,mirror:!!x.mirror,colorize:!!x.colorize,lock:!!x.lock,comment:void 0!==g},R=p.encode(O);if(r.push(R,3),void 0!==g){var z=escape(s.comment),A=Math.min(z.length,4095);r.push(A,2);for(var E=0;E<A;E+=4){for(var M=0,q=0;q<4;q+=1){var L=E+q;if(A<=L)break;var S=z.charAt(L);M+=l.encode(S,q)}r.push(M,5)}}else void 0===s.comment&&(h=void 0);O.lock&&((0,c.isMinoPiece)(O.piece.type)&&y.fill(O.piece),y.clearLine(),O.rise&&y.riseGarbage(),O.mirror&&y.mirror()),f=y},y=0;y<e.length;y+=1)v(y);var g=r.toString();if(g.length<41)return g;var m=[g.substr(0,42)],b=g.substring(42).match(/[\S]{1,47}/g)||[];return m.concat(b).join("?")}},398:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.decode=t.extract=t.Page=void 0;var i=r(917),n=r(74),o=r(746),c=r(42),a=r(254),s=r(633),u=r(326),f=function(){function e(e,t,r,i,n,o){this.index=e,this.operation=r,this.comment=i,this.flags=n,this.refs=o,this._field=t.copy()}return Object.defineProperty(e.prototype,"field",{get:function(){return new u.Field(this._field.copy())},set:function(e){this._field=(0,i.createInnerField)(e)},enumerable:!1,configurable:!0}),e.prototype.mino=function(){return u.Mino.from(this.operation)},e}();t.Page=f;function p(e){var t,r=function(e,t){return{version:e,data:t.trim().replace(/[?\s]+/g,"")}},i=e,n=i.indexOf("&");if(0<=n&&(i=i.substring(0,n)),null!=(t=e.match(/[vmd]115@/))&&void 0!==t.index)return r("115",i.substr(t.index+5));if(null!=(t=e.match(/[vmd]110@/))&&void 0!==t.index)return r("110",i.substr(t.index+5));throw new Error("Unsupported fumen version")}function l(e,t){for(var r=10*(t+1),p=new n.Buffer(e),l=function(e){for(var i={changed:!0,field:e},n=0;n<r;){var o=p.poll(2),c=Math.floor(o/r),a=o%r;8===c&&a===r-1&&(i.changed=!1);for(var s=0;s<a+1;s+=1){var u=n%10,f=t-Math.floor(n/10)-1;i.field.addNumber(u,f,c-8),n+=1}}return i},h=0,d=(0,i.createNewInnerField)(),v={repeatCount:-1,refIndex:{comment:0,field:0},quiz:void 0,lastCommentText:""},y=[],g=(0,c.createActionDecoder)(10,t,1),m=(0,a.createCommentParser)();!p.isEmpty();){var b=void 0;0<v.repeatCount?(b={field:d,changed:!1},v.repeatCount-=1):(b=l(d.copy())).changed||(v.repeatCount=p.poll(1));var P=p.poll(3),w=g.decode(P),x=void 0;if(w.comment){for(var O=[],R=p.poll(2),z=0;z<Math.floor((R+3)/4);z+=1){var A=p.poll(5);O.push(A)}for(var E="",M=0,q=O;M<q.length;M++){var L=q[M];E+=m.decode(L)}var S=unescape(E.slice(0,R));v.lastCommentText=S,x={text:S},v.refIndex.comment=h;var I=x.text;if(s.Quiz.isQuizComment(I))try{v.quiz=new s.Quiz(I)}catch(e){v.quiz=void 0}else v.quiz=void 0}else x=0===h?{text:""}:{text:void 0!==v.quiz?v.quiz.format().toString():void 0,ref:v.refIndex.comment};var _=!1;if(void 0!==v.quiz&&(_=!0,v.quiz.canOperate()&&w.lock))if((0,o.isMinoPiece)(w.piece.type))try{var N=v.quiz.nextIfEnd(),k=N.getOperation(w.piece.type);v.quiz=N.operate(k)}catch(e){v.quiz=v.quiz.format()}else v.quiz=v.quiz.format();var j=void 0;w.piece.type!==o.Piece.Empty&&(j=w.piece);var F=void 0;b.changed||0===h?(F={},v.refIndex.field=h):F={ref:v.refIndex.field},y.push(new f(h,b.field,void 0!==j?u.Mino.from({type:(0,o.parsePieceName)(j.type),rotation:(0,o.parseRotationName)(j.rotation),x:j.x,y:j.y}):void 0,void 0!==x.text?x.text:v.lastCommentText,{quiz:_,lock:w.lock,mirror:w.mirror,colorize:w.colorize,rise:w.rise},{field:F.ref,comment:x.ref})),h+=1,w.lock&&((0,o.isMinoPiece)(w.piece.type)&&b.field.fill(w.piece),b.field.clearLine(),w.rise&&b.field.riseGarbage(),w.mirror&&b.field.mirror()),d=b.field}return y}t.extract=p,t.decode=function(e){var t=p(e),r=t.version,i=t.data;switch(r){case"115":return l(i,23);case"110":return l(i,21)}throw new Error("Unsupported fumen version")}},633:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Quiz=void 0;var i,n=r(746);!function(e){e.Direct="direct",e.Swap="swap",e.Stock="stock"}(i||(i={}));var o=function(){function e(t){this.quiz=e.verify(t)}return Object.defineProperty(e.prototype,"next",{get:function(){var e=this.quiz.indexOf(")")+1,t=this.quiz[e];return void 0===t||";"===t?"":t},enumerable:!1,configurable:!0}),e.isQuizComment=function(e){return e.startsWith("#Q=")},e.create=function(t,r){var i=function(t,r){var i=function(e){return e||""};return new e("#Q=[".concat(i(t),"](").concat(i(r[0]),")").concat(i(r.substring(1))))};return void 0!==r?i(t,r):i(void 0,t)},e.trim=function(e){return e.trim().replace(/\s+/g,"")},Object.defineProperty(e.prototype,"least",{get:function(){var e=this.quiz.indexOf(")");return this.quiz.substr(e+1)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"current",{get:function(){var e=this.quiz.indexOf("(")+1,t=this.quiz[e];return")"===t?"":t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hold",{get:function(){var e=this.quiz.indexOf("[")+1,t=this.quiz[e];return"]"===t?"":t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"leastAfterNext2",{get:function(){var e=this.quiz.indexOf(")");return";"===this.quiz[e+1]?this.quiz.substr(e+1):this.quiz.substr(e+2)},enumerable:!1,configurable:!0}),e.prototype.getOperation=function(e){var t=(0,n.parsePieceName)(e),r=this.current;if(t===r)return i.Direct;var o=this.hold;if(t===o)return i.Swap;if(""===o){if(t===this.next)return i.Stock}else if(""===r&&t===this.next)return i.Direct;throw new Error("Unexpected hold piece in quiz: ".concat(this.quiz))},Object.defineProperty(e.prototype,"leastInActiveBag",{get:function(){var e=this.quiz.indexOf(";"),t=0<=e?this.quiz.substring(0,e):this.quiz,r=t.indexOf(")");return";"===t[r+1]?t.substr(r+1):t.substr(r+2)},enumerable:!1,configurable:!0}),e.verify=function(e){var t=this.trim(e);if(0===t.length||"#Q=[]()"===e||!e.startsWith("#Q="))return e;if(!t.match(/^#Q=\[[TIOSZJL]?]\([TIOSZJL]?\)[TIOSZJL]*;?.*$/i))throw new Error("Current piece doesn't exist, however next pieces exist: ".concat(e));return t},e.prototype.direct=function(){if(""===this.current){var t=this.leastAfterNext2;return new e("#Q=[".concat(this.hold,"](").concat(t[0],")").concat(t.substr(1)))}return new e("#Q=[".concat(this.hold,"](").concat(this.next,")").concat(this.leastAfterNext2))},e.prototype.swap=function(){if(""===this.hold)throw new Error("Cannot find hold piece: ".concat(this.quiz));var t=this.next;return new e("#Q=[".concat(this.current,"](").concat(t,")").concat(this.leastAfterNext2))},e.prototype.stock=function(){if(""!==this.hold||""===this.next)throw new Error("Cannot stock: ".concat(this.quiz));var t=this.leastAfterNext2,r=void 0!==t[0]?t[0]:"";return 1<t.length?new e("#Q=[".concat(this.current,"](").concat(r,")").concat(t.substr(1))):new e("#Q=[".concat(this.current,"](").concat(r,")"))},e.prototype.operate=function(e){switch(e){case i.Direct:return this.direct();case i.Swap:return this.swap();case i.Stock:return this.stock()}throw new Error("Unexpected operation")},e.prototype.format=function(){var t=this.nextIfEnd();if("#Q=[]()"===t.quiz)return new e("");var r=t.current,i=t.hold;if(""===r&&""!==i)return new e("#Q=[](".concat(i,")").concat(t.least));if(""===r){var n=t.least,o=n[0];return new e(void 0===o?"":";"===o?n.substr(1):"#Q=[](".concat(o,")").concat(n.substr(1)))}return t},e.prototype.getHoldPiece=function(){if(!this.canOperate())return n.Piece.Empty;var e=this.hold;return void 0===e||""===e||";"===e?n.Piece.Empty:(0,n.parsePiece)(e)},e.prototype.getNextPieces=function(e){if(!this.canOperate())return void 0!==e?Array.from({length:e}).map(function(){return n.Piece.Empty}):[];var t=(this.current+this.next+this.leastInActiveBag).substr(0,e);return void 0!==e&&t.length<e&&(t+=" ".repeat(e-t.length)),t.split("").map(function(e){return void 0===e||" "===e||";"===e?n.Piece.Empty:(0,n.parsePiece)(e)})},e.prototype.toString=function(){return this.quiz},e.prototype.canOperate=function(){var e=this.quiz;return e.startsWith("#Q=[]();")&&(e=this.quiz.substr(8)),e.startsWith("#Q=")&&"#Q=[]()"!==e},e.prototype.nextIfEnd=function(){return this.quiz.startsWith("#Q=[]();")?new e(this.quiz.substr(8)):this},e}();t.Quiz=o},746:(e,t)=>{var r,i;Object.defineProperty(t,"__esModule",{value:!0}),t.parseRotation=t.parseRotationName=t.Rotation=t.parsePiece=t.parsePieceName=t.isMinoPiece=t.Piece=void 0,function(e){e[e.Empty=0]="Empty",e[e.I=1]="I",e[e.L=2]="L",e[e.O=3]="O",e[e.Z=4]="Z",e[e.T=5]="T",e[e.J=6]="J",e[e.S=7]="S",e[e.Gray=8]="Gray"}(r=t.Piece||(t.Piece={})),t.isMinoPiece=function(e){return e!==r.Empty&&e!==r.Gray},t.parsePieceName=function(e){switch(e){case r.I:return"I";case r.L:return"L";case r.O:return"O";case r.Z:return"Z";case r.T:return"T";case r.J:return"J";case r.S:return"S";case r.Gray:return"X";case r.Empty:return"_"}throw new Error("Unknown piece: ".concat(e))},t.parsePiece=function(e){switch(e.toUpperCase()){case"I":return r.I;case"L":return r.L;case"O":return r.O;case"Z":return r.Z;case"T":return r.T;case"J":return r.J;case"S":return r.S;case"X":case"GRAY":return r.Gray;case" ":case"_":case"EMPTY":return r.Empty}throw new Error("Unknown piece: ".concat(e))},function(e){e[e.Spawn=0]="Spawn",e[e.Right=1]="Right",e[e.Reverse=2]="Reverse",e[e.Left=3]="Left"}(i=t.Rotation||(t.Rotation={})),t.parseRotationName=function(e){switch(e){case i.Spawn:return"spawn";case i.Left:return"left";case i.Right:return"right";case i.Reverse:return"reverse"}throw new Error("Unknown rotation: ".concat(e))},t.parseRotation=function(e){switch(e.toLowerCase()){case"spawn":return i.Spawn;case"left":return i.Left;case"right":return i.Right;case"reverse":return i.Reverse}throw new Error("Unknown rotation: ".concat(e))}},917:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getPieces=t.getBlocks=t.getBlockXYs=t.getBlockPositions=t.PlayField=t.InnerField=t.createInnerField=t.createNewInnerField=void 0;var i=r(746),n=10,o=23,c=230;t.createNewInnerField=function(){return new a({})},t.createInnerField=function(e){for(var t=new a({}),r=-1;r<o;r+=1)for(var c=0;c<n;c+=1){var s=e.at(c,r);t.setNumberAt(c,r,(0,i.parsePiece)(s))}return t};var a=function(){function e(t){var r=t.field,i=void 0===r?e.create(c):r,o=t.garbage,a=void 0===o?e.create(n):o;this.field=i,this.garbage=a}return e.create=function(e){return new s({length:e})},e.prototype.fill=function(e){this.field.fill(e)},e.prototype.fillAll=function(e,t){this.field.fillAll(e,t)},e.prototype.canFill=function(e,t,r,n){var c=this;return u(e,t,r,n).every(function(e){var t=e[0],r=e[1];return 0<=t&&t<10&&0<=r&&r<o&&c.getNumberAt(t,r)===i.Piece.Empty})},e.prototype.canFillAll=function(e){var t=this;return e.every(function(e){var r=e.x,n=e.y;return 0<=r&&r<10&&0<=n&&n<o&&t.getNumberAt(r,n)===i.Piece.Empty})},e.prototype.isOnGround=function(e,t,r,i){return!this.canFill(e,t,r,i-1)},e.prototype.clearLine=function(){this.field.clearLine()},e.prototype.riseGarbage=function(){this.field.up(this.garbage),this.garbage.clearAll()},e.prototype.mirror=function(){this.field.mirror()},e.prototype.shiftToLeft=function(){this.field.shiftToLeft()},e.prototype.shiftToRight=function(){this.field.shiftToRight()},e.prototype.shiftToUp=function(){this.field.shiftToUp()},e.prototype.shiftToBottom=function(){this.field.shiftToBottom()},e.prototype.copy=function(){return new e({field:this.field.copy(),garbage:this.garbage.copy()})},e.prototype.equals=function(e){return this.field.equals(e.field)&&this.garbage.equals(e.garbage)},e.prototype.addNumber=function(e,t,r){0<=t?this.field.addOffset(e,t,r):this.garbage.addOffset(e,-(t+1),r)},e.prototype.setNumberFieldAt=function(e,t){this.field.setAt(e,t)},e.prototype.setNumberGarbageAt=function(e,t){this.garbage.setAt(e,t)},e.prototype.setNumberAt=function(e,t,r){return 0<=t?this.field.set(e,t,r):this.garbage.set(e,-(t+1),r)},e.prototype.getNumberAt=function(e,t){return 0<=t?this.field.get(e,t):this.garbage.get(e,-(t+1))},e.prototype.getNumberAtIndex=function(e,t){return t?this.getNumberAt(e%10,Math.floor(e/10)):this.getNumberAt(e%10,-(Math.floor(e/10)+1))},e.prototype.toFieldNumberArray=function(){return this.field.toArray()},e.prototype.toGarbageNumberArray=function(){return this.garbage.toArray()},e}();t.InnerField=a;var s=function(){function e(e){var t=e.pieces,r=e.length,n=void 0===r?c:r;this.pieces=void 0!==t?t:Array.from({length:n}).map(function(){return i.Piece.Empty}),this.length=n}return e.load=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var i=t.join("").trim();return e.loadInner(i)},e.loadMinify=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var i=t.join("").trim();return e.loadInner(i,i.length)},e.loadInner=function(t,r){var n=void 0!==r?r:t.length;if(n%10!=0)throw new Error("Num of blocks in field should be mod 10");for(var o=new e(void 0!==r?{length:r}:{}),c=0;c<n;c+=1){var a=t[c];o.set(c%10,Math.floor((n-c-1)/10),(0,i.parsePiece)(a))}return o},e.prototype.get=function(e,t){return this.pieces[e+t*n]},e.prototype.addOffset=function(e,t,r){this.pieces[e+t*n]+=r},e.prototype.set=function(e,t,r){this.setAt(e+t*n,r)},e.prototype.setAt=function(e,t){this.pieces[e]=t},e.prototype.fill=function(e){for(var t=e.type,r=e.rotation,i=e.x,n=e.y,o=0,c=f(t,r);o<c.length;o++){var a=c[o],s=[i+a[0],n+a[1]],u=s[0],p=s[1];this.set(u,p,t)}},e.prototype.fillAll=function(e,t){for(var r=0,i=e;r<i.length;r++){var n=i[r],o=n.x,c=n.y;this.set(o,c,t)}},e.prototype.clearLine=function(){for(var e=this.pieces.concat(),t=this.pieces.length/n-1;0<=t;t-=1)if(this.pieces.slice(t*n,(t+1)*n).every(function(e){return e!==i.Piece.Empty})){var r=e.slice(0,t*n),o=e.slice((t+1)*n);e=r.concat(o,Array.from({length:n}).map(function(){return i.Piece.Empty}))}this.pieces=e},e.prototype.up=function(e){this.pieces=e.pieces.concat(this.pieces).slice(0,this.length)},e.prototype.mirror=function(){for(var e=[],t=0;t<this.pieces.length;t+=1){var r=this.pieces.slice(t*n,(t+1)*n);r.reverse();for(var i=0,o=r;i<o.length;i++){var c=o[i];e.push(c)}}this.pieces=e},e.prototype.shiftToLeft=function(){for(var e=this.pieces.length/10,t=0;t<e;t+=1){for(var r=0;r<n-1;r+=1)this.pieces[r+t*n]=this.pieces[r+1+t*n];this.pieces[9+t*n]=i.Piece.Empty}},e.prototype.shiftToRight=function(){for(var e=this.pieces.length/10,t=0;t<e;t+=1){for(var r=n-1;1<=r;r-=1)this.pieces[r+t*n]=this.pieces[r-1+t*n];this.pieces[t*n]=i.Piece.Empty}},e.prototype.shiftToUp=function(){var e=Array.from({length:10}).map(function(){return i.Piece.Empty});this.pieces=e.concat(this.pieces).slice(0,this.length)},e.prototype.shiftToBottom=function(){var e=Array.from({length:10}).map(function(){return i.Piece.Empty});this.pieces=this.pieces.slice(10,this.length).concat(e)},e.prototype.toArray=function(){return this.pieces.concat()},Object.defineProperty(e.prototype,"numOfBlocks",{get:function(){return this.pieces.length},enumerable:!1,configurable:!0}),e.prototype.copy=function(){return new e({pieces:this.pieces.concat(),length:this.length})},e.prototype.toShallowArray=function(){return this.pieces},e.prototype.clearAll=function(){this.pieces=this.pieces.map(function(){return i.Piece.Empty})},e.prototype.equals=function(e){if(this.pieces.length!==e.pieces.length)return!1;for(var t=0;t<this.pieces.length;t+=1)if(this.pieces[t]!==e.pieces[t])return!1;return!0},e}();function u(e,t,r,i){return f(e,t).map(function(e){return e[0]+=r,e[1]+=i,e})}function f(e,t){var r=p(e);switch(t){case i.Rotation.Spawn:return r;case i.Rotation.Left:return r.map(function(e){return[-e[1],e[0]]});case i.Rotation.Reverse:return r.map(function(e){return[-e[0],-e[1]]});case i.Rotation.Right:return function(e){return e.map(function(e){return[e[1],-e[0]]})}(r)}throw new Error("Unsupported block")}function p(e){switch(e){case i.Piece.I:return[[0,0],[-1,0],[1,0],[2,0]];case i.Piece.T:return[[0,0],[-1,0],[1,0],[0,1]];case i.Piece.O:return[[0,0],[1,0],[0,1],[1,1]];case i.Piece.L:return[[0,0],[-1,0],[1,0],[1,1]];case i.Piece.J:return[[0,0],[-1,0],[1,0],[-1,1]];case i.Piece.S:return[[0,0],[-1,0],[0,1],[1,1]];case i.Piece.Z:return[[0,0],[1,0],[0,1],[-1,1]]}throw new Error("Unsupported rotation")}t.PlayField=s,t.getBlockPositions=u,t.getBlockXYs=function(e,t,r,i){return f(e,t).map(function(e){return{x:e[0]+r,y:e[1]+i}})},t.getBlocks=f,t.getPieces=p}},t={};function r(i){var n=t[i];if(void 0!==n)return n.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,r),o.exports}var i={};return(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0}),e.encoder=e.decoder=e.Mino=e.Field=void 0;var t=r(398),n=r(370),o=r(326);Object.defineProperty(e,"Field",{enumerable:!0,get:function(){return o.Field}}),Object.defineProperty(e,"Mino",{enumerable:!0,get:function(){return o.Mino}}),e.decoder={decode:function(e){return(0,t.decode)(e)}},e.encoder={encode:function(e){return"v115@".concat((0,n.encode)(e))}}})(),i})());